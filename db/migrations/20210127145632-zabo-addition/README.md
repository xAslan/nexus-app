# Migration `20210127145632-zabo-addition`

This migration has been generated by maotora at 1/27/2021, 5:56:32 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."AccountType" AS ENUM ('BLOCKCHAIN_WALLET', 'TRADITIONAL_BANK', 'TRADITIONAL_BROKERAGE', 'TRADITIONAL_CREDIT', 'CRYPTO_EXCHANGE', 'CRYPTO_SERVICE', 'UNKNOWN')

CREATE TABLE "User" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT,
    "email" TEXT NOT NULL,
    "hashedPassword" TEXT,
    "role" TEXT NOT NULL DEFAULT E'user',
    "zaboUserId" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "Session" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "expiresAt" TIMESTAMP(3),
    "handle" TEXT NOT NULL,
    "userId" INTEGER,
    "hashedSessionToken" TEXT,
    "antiCSRFToken" TEXT,
    "publicData" TEXT,
    "privateData" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "Institution" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT NOT NULL,
    "authType" TEXT NOT NULL DEFAULT E'none',
    "shortName" TEXT NOT NULL,
    "logoURL" TEXT,
    "type" "AccountType" NOT NULL DEFAULT E'UNKNOWN',

    PRIMARY KEY ("id")
)

CREATE TABLE "Account" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT NOT NULL,
    "apiKey" TEXT,
    "apiSecret" TEXT,
    "plaidToken" TEXT,
    "type" "AccountType" NOT NULL,
    "userId" INTEGER NOT NULL,
    "zaboAccountId" TEXT,
    "zaboId" INTEGER NOT NULL,
    "lastSync" TIMESTAMP(3),
    "lastSyncEnd" TIMESTAMP(3),
    "syncStatus" TEXT NOT NULL DEFAULT E'inactive',
    "institutionId" INTEGER,

    PRIMARY KEY ("id")
)

CREATE TABLE "Zabo" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "userId" TEXT NOT NULL,
    "infoObject" JSONB NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "Wallet" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "symbol" TEXT NOT NULL,
    "xpub" TEXT,
    "address" TEXT,
    "accountId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "SubAccount" (
"id" SERIAL,
    "clientAccountId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT NOT NULL,
    "accountId" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "Holding" (
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "assetId" INTEGER NOT NULL,
    "amount" DECIMAL(65,30) NOT NULL,
    "subAccountId" INTEGER NOT NULL,

    PRIMARY KEY ("assetId","subAccountId")
)

CREATE TABLE "Asset" (
"id" SERIAL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT NOT NULL,
    "symbol" TEXT NOT NULL,
    "address" TEXT NOT NULL DEFAULT E'0',

    PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "User.email_unique" ON "User"("email")

CREATE UNIQUE INDEX "User.zaboUserId_unique" ON "User"("zaboUserId")

CREATE UNIQUE INDEX "Session.handle_unique" ON "Session"("handle")

CREATE UNIQUE INDEX "Institution.shortName_unique" ON "Institution"("shortName")

CREATE UNIQUE INDEX "Account.zaboAccountId_unique" ON "Account"("zaboAccountId")

CREATE UNIQUE INDEX "Wallet_accountId_unique" ON "Wallet"("accountId")

CREATE UNIQUE INDEX "Asset.symbol_address_unique" ON "Asset"("symbol", "address")

ALTER TABLE "Session" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "Account" ADD FOREIGN KEY("institutionId")REFERENCES "Institution"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "Account" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Account" ADD FOREIGN KEY("zaboId")REFERENCES "Zabo"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Zabo" ADD FOREIGN KEY("userId")REFERENCES "User"("zaboUserId") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Wallet" ADD FOREIGN KEY("accountId")REFERENCES "Account"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "SubAccount" ADD FOREIGN KEY("accountId")REFERENCES "Account"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Holding" ADD FOREIGN KEY("assetId")REFERENCES "Asset"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Holding" ADD FOREIGN KEY("subAccountId")REFERENCES "SubAccount"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210126091224-added-institution-url..20210127145632-zabo-addition
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgres"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -12,16 +12,17 @@
 // --------------------------------------
 model User {
-  id             Int       @default(autoincrement()) @id
-  createdAt      DateTime  @default(now())
-  updatedAt      DateTime  @updatedAt
-  name           String?
-  email          String    @unique
-  hashedPassword String?
-  role           String    @default("user")
-  sessions       Session[]
+  id              Int       @default(autoincrement()) @id
+  createdAt       DateTime  @default(now())
+  updatedAt       DateTime  @updatedAt
+  name            String?
+  email           String    @unique
+  hashedPassword  String?
+  role            String    @default("user")
+  sessions        Session[]
+  zaboUserId      String?       @unique
 }
 model Session {
   id                 Int       @default(autoincrement()) @id
@@ -48,26 +49,39 @@
   type      AccountType   @default(UNKNOWN) // traditional, brokerage, bank, crypto_exchange, etc. make this into an ENUM and save in DB
 }
 model Account {
-  id          Int          @default(autoincrement()) @id
-  createdAt   DateTime     @default(now())
-  updatedAt   DateTime     @updatedAt
-  name        String       // display name for account
-  apiKey      String?      
-  apiSecret   String?
-  plaidToken  String?      
-  institution Institution? 
-  type        AccountType       //manual, blockchain_wallet, institution, defi ENUM
-  wallet      Wallet?
-  subAccounts SubAccount[]    
-  user        User         @relation(fields: [userId], references: [id])
-  userId      Int          
-  lastSync    DateTime?
-  lastSyncEnd DateTime?
-  syncStatus  String       @default("inactive")
+  id              Int           @default(autoincrement()) @id
+  createdAt       DateTime      @default(now())
+  updatedAt       DateTime      @updatedAt
+  name            String        // display name for account
+  apiKey          String?      
+  apiSecret       String?
+  plaidToken      String?      
+  institution     Institution? 
+  type            AccountType       //manual, blockchain_wallet, institution, defi ENUM
+  wallet          Wallet?
+  subAccounts     SubAccount[]    
+  user            User          @relation(fields: [userId], references: [id])
+  userId          Int          
+  zaboAccountId   String?       @unique
+  zaboId          Int
+  zabo            Zabo          @relation(fields: [zaboId], references: [id])
+  lastSync        DateTime?
+  lastSyncEnd     DateTime?
+  syncStatus      String        @default("inactive")
 }
+model Zabo {
+  id              Int           @default(autoincrement()) @id
+  createdAt       DateTime      @default(now())
+  updatedAt       DateTime      @updatedAt
+  zaboAccounts    Account[]
+  userId          String
+  zaboUser        User          @relation(fields: [userId], references: [zaboUserId])
+  infoObject      Json
+}
+
 model Wallet {
   id        Int       @default(autoincrement()) @id
   createdAt DateTime  @default(now())
   updatedAt DateTime  @updatedAt
@@ -89,15 +103,15 @@
   accountId Int
 }
 model Holding {
-  createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt
-  asset    Asset  @relation(fields: [assetId], references: [id])
-  assetId  Int
-  amount    Float
+  createdAt     DateTime @default(now())
+  updatedAt     DateTime @updatedAt
+  asset         Asset  @relation(fields: [assetId], references: [id])
+  assetId       Int
+  amount        Float
   subAccount    SubAccount  @relation(fields: [subAccountId], references: [id])
-  subAccountId Int 
+  subAccountId  Int 
   @@id([assetId, subAccountId])
 }
 model Asset {
```


